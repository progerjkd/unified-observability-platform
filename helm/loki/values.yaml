# Grafana Loki - Simple Scalable mode
# Helm chart: grafana/loki
# Docs: https://grafana.com/docs/loki/latest/

loki:
  auth_enabled: false

  storage:
    type: s3
    s3:
      endpoint: s3.us-east-1.amazonaws.com
      bucketnames: ${org_prefix}-obs-loki
      region: us-east-1
      # Authentication via IRSA

  schemaConfig:
    configs:
      - from: "2024-01-01"
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  limits_config:
    retention_period: 720h  # 30 days
    ingestion_rate_mb: 50
    ingestion_burst_size_mb: 100
    max_query_series: 5000
    max_entries_limit_per_query: 10000
    per_stream_rate_limit: 5MB
    per_stream_rate_limit_burst: 15MB

  # Enable OTLP ingestion
  server:
    grpc_server_max_recv_msg_size: 8388608  # 8MB

  # Pattern for structured metadata extraction
  pattern_ingester:
    enabled: true

  # Ruler for log-based alerting
  rulerConfig:
    alertmanager_url: http://alertmanager.observability.svc:9093
    enable_api: true
    storage:
      type: s3
      s3:
        bucketnames: ${org_prefix}-obs-loki

# ------- Component sizing for ~500 instances -------

write:
  replicas: 3
  resources:
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "1"
      memory: "4Gi"
  persistence:
    size: 50Gi
    storageClassName: gp3
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/component: write

read:
  replicas: 2
  resources:
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "1"
      memory: "4Gi"

backend:
  replicas: 2
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "1"
      memory: "2Gi"
  persistence:
    size: 50Gi
    storageClassName: gp3

# OTLP endpoint for direct ingestion from OTel Collector
gateway:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"

# Service account with IRSA
serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: ${loki_irsa_role_arn}
