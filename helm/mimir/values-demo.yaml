# Mimir demo overrides — minimal sizing for sample-app load only
# Usage: helm upgrade --install mimir grafana/mimir-distributed \
#          -f helm/mimir/values.yaml -f helm/mimir/values-demo.yaml

# ---------- Storage: use S3 directly (no MinIO) ----------
mimir:
  structuredConfig:
    common:
      storage:
        backend: s3
        s3:
          endpoint: s3.us-east-1.amazonaws.com
          bucket_name: odontoagil-obs-mimir
          region: us-east-1

    # Disable Kafka-based ingest storage (Mimir 3.x default)
    # When ingest storage is disabled, use classic ingestion path
    ingest_storage:
      enabled: false

    # Enable classic ingestion ring (required when ingest storage is off)
    ingester:
      ring:
        kvstore:
          store: memberlist
      # Explicitly enable Push gRPC method for classic ingestion
      push_grpc_method_enabled: true

    blocks_storage:
      tsdb:
        retention_period: 24h
        block_ranges_period: [2h]
      bucket_store:
        sync_interval: 15m

    # Alertmanager needs a separate storage prefix to avoid conflict with blocks
    alertmanager_storage:
      backend: s3
      s3:
        endpoint: s3.us-east-1.amazonaws.com
        bucket_name: odontoagil-obs-mimir
        region: us-east-1
      storage_prefix: alertmanager

    # Ruler storage — separate prefix
    ruler_storage:
      backend: s3
      s3:
        endpoint: s3.us-east-1.amazonaws.com
        bucket_name: odontoagil-obs-mimir
        region: us-east-1
      storage_prefix: ruler

    compactor:
      data_dir: /data/compactor
      sharding_ring:
        kvstore:
          store: memberlist

    ruler:
      enable_api: true
      rule_path: /data/rules

    limits:
      max_global_series_per_user: 50000
      ingestion_rate: 10000
      ingestion_burst_size: 20000

# ---------- Disable MinIO (we use S3) ----------
minio:
  enabled: false

# ---------- Disable Kafka (not needed for demo) ----------
kafka:
  enabled: false

# ---------- Disable ingest-storage (Kafka-based) ----------
ingester:
  replicas: 1
  zoneAwareReplication:
    enabled: false
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "250m"
      memory: "512Mi"
  persistentVolume:
    size: 5Gi

distributor:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "250m"
      memory: "512Mi"

compactor:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "250m"
      memory: "512Mi"
  persistentVolume:
    size: 5Gi

querier:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "250m"
      memory: "512Mi"

query_frontend:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "250m"
      memory: "512Mi"

store_gateway:
  replicas: 1
  zoneAwareReplication:
    enabled: false
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
  persistentVolume:
    size: 5Gi

ruler:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"

alertmanager:
  replicas: 1
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
  persistentVolume:
    size: 1Gi

# ---------- IRSA for S3 access ----------
serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::699475921438:role/obs-lgtm-demo-mimir-s3-access
