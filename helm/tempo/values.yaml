# Grafana Tempo - Distributed mode
# Helm chart: grafana/tempo-distributed
# Docs: https://grafana.com/docs/tempo/latest/

tempo:
  storage:
    trace:
      backend: s3
      s3:
        bucket: ${org_prefix}-tempo
        endpoint: s3.us-east-1.amazonaws.com
        region: us-east-1
        # Authentication via IRSA

  retention: 336h  # 14 days

  # Memberlist for ring coordination
  memberlist:
    bind_addr:
      - "0.0.0.0"

# ------- Component sizing for ~500 instances -------

ingester:
  replicas: 3
  resources:
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "1"
      memory: "4Gi"
  persistence:
    enabled: true
    size: 20Gi
    storageClass: gp3
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/component: ingester

distributor:
  replicas: 2
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "1"
      memory: "2Gi"

compactor:
  replicas: 1
  resources:
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "1"
      memory: "4Gi"

querier:
  replicas: 2
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "1"
      memory: "2Gi"

queryFrontend:
  replicas: 2
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

metricsGenerator:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
  config:
    storage:
      remote_write:
        - url: http://mimir-distributor.observability.svc:8080/api/v1/push
          headers:
            X-Scope-OrgID: anonymous
    processor:
      service_graphs:
        dimensions:
          - service.namespace
          - deployment.environment
      span_metrics:
        dimensions:
          - service.namespace
          - deployment.environment
          - http.method
          - http.status_code

# Gateway for receiving OTLP data
gateway:
  enabled: true
  replicas: 1

# Global overrides â€” enable metrics generator processors
overrides:
  defaults:
    ingestion:
      rate_limit_bytes: 15000000  # 15MB/s
      burst_size_bytes: 20000000  # 20MB
    metrics_generator:
      processors:
        - service-graphs
        - span-metrics

# Service account with IRSA
serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: ${tempo_irsa_role_arn}
