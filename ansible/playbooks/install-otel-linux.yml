---
# Install OpenTelemetry Collector on on-premises Linux hosts
- name: Install OpenTelemetry Collector on Linux
  hosts: onprem_linux
  become: true
  vars:
    otel_version: "0.96.0"
    otel_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"
    otel_binary: "otelcol-contrib"
    otel_install_dir: /usr/local/bin
    otel_config_dir: /etc/otelcol-contrib
    otel_data_dir: /var/lib/otelcol
    otel_log_dir: /var/log/otelcol
    gateway_endpoint: "gateway.observability.internal:4317"
    ca_cert_source: "files/ca.pem"

  tasks:
    - name: Create otelcol system user
      user:
        name: otelcol
        system: true
        shell: /usr/sbin/nologin
        create_home: false

    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
        owner: otelcol
        group: otelcol
        mode: "0755"
      loop:
        - "{{ otel_config_dir }}"
        - "{{ otel_data_dir }}"
        - "{{ otel_data_dir }}/queue"
        - "{{ otel_log_dir }}"

    - name: Check if OTel Collector is already installed
      stat:
        path: "{{ otel_install_dir }}/{{ otel_binary }}"
      register: otel_binary_stat

    - name: Check installed version
      command: "{{ otel_install_dir }}/{{ otel_binary }} --version"
      register: otel_installed_version
      changed_when: false
      failed_when: false
      when: otel_binary_stat.stat.exists

    - name: Download OTel Collector
      get_url:
        url: "https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v{{ otel_version }}/otelcol-contrib_{{ otel_version }}_linux_{{ otel_arch }}.tar.gz"
        dest: "/tmp/otelcol-contrib.tar.gz"
        mode: "0644"
      when: >
        not otel_binary_stat.stat.exists or
        (otel_installed_version.stdout is defined and otel_version not in otel_installed_version.stdout)

    - name: Extract OTel Collector binary
      unarchive:
        src: /tmp/otelcol-contrib.tar.gz
        dest: "{{ otel_install_dir }}"
        remote_src: true
        extra_opts:
          - "{{ otel_binary }}"
      when: >
        not otel_binary_stat.stat.exists or
        (otel_installed_version.stdout is defined and otel_version not in otel_installed_version.stdout)
      notify: restart otelcol

    - name: Set binary permissions
      file:
        path: "{{ otel_install_dir }}/{{ otel_binary }}"
        mode: "0755"
        owner: root
        group: root

    - name: Deploy CA certificate
      copy:
        src: "{{ ca_cert_source }}"
        dest: "{{ otel_config_dir }}/ca.pem"
        owner: otelcol
        group: otelcol
        mode: "0644"
      notify: restart otelcol

    - name: Deploy OTel Collector config
      template:
        src: templates/otel-agent-linux.yaml.j2
        dest: "{{ otel_config_dir }}/config.yaml"
        owner: otelcol
        group: otelcol
        mode: "0640"
        validate: "{{ otel_install_dir }}/{{ otel_binary }} validate --config %s"
      notify: restart otelcol

    - name: Deploy systemd unit file
      template:
        src: templates/otelcol.service.j2
        dest: /etc/systemd/system/otelcol-contrib.service
        mode: "0644"
      notify:
        - reload systemd
        - restart otelcol

    - name: Enable and start OTel Collector service
      systemd:
        name: otelcol-contrib
        state: started
        enabled: true
        daemon_reload: true

    - name: Wait for health check
      uri:
        url: "http://localhost:13133/health"
        status_code: 200
      register: health_check
      retries: 5
      delay: 5
      until: health_check.status == 200

    - name: Clean up downloaded archive
      file:
        path: /tmp/otelcol-contrib.tar.gz
        state: absent

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: true

    - name: restart otelcol
      systemd:
        name: otelcol-contrib
        state: restarted
